<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ReMemory Recovery Tool</title>
  <style>{{STYLES}}</style>
</head>
<body>
  <!-- Loading overlay -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="spinner"></div>
    <p style="margin-top: 1rem; color: #7f8c8d;">Loading recovery module...</p>
  </div>

  <div class="container">
    <header>
      <h1>ReMemory Recovery</h1>
      <p>Recover your encrypted files using Shamir's Secret Sharing</p>
    </header>

    <!-- Step 1: Collect Shares -->
    <div class="card">
      <h2><span class="step-number">1</span> Collect Shares</h2>
      <div id="share-drop-zone" class="drop-zone">
        <p>Drag & drop README.txt files here, or click to browse</p>
        <small>Each README.txt contains the share for that person</small>
      </div>
      <input type="file" id="share-file-input" accept=".txt,.pdf" multiple>

      <div id="shares-list" class="shares-list"></div>

      <div id="threshold-info" class="threshold-info hidden"></div>
    </div>

    <!-- Step 2: Load Manifest -->
    <div class="card">
      <h2><span class="step-number">2</span> Load Encrypted Manifest</h2>
      <div id="manifest-drop-zone" class="drop-zone">
        <p>Drag & drop MANIFEST.age here, or click to browse</p>
        <small>This is the encrypted file containing your secrets</small>
      </div>
      <input type="file" id="manifest-file-input" accept=".age">

      <div id="manifest-status" class="manifest-status hidden">
        <span class="icon">&#128196;</span>
        <div>No manifest loaded</div>
      </div>
    </div>

    <!-- Step 3: Recover -->
    <div class="card">
      <h2><span class="step-number">3</span> Recover Files</h2>
      <div id="recover-section" class="recover-section">
        <button id="recover-btn" class="btn btn-primary" disabled>
          <span>&#128275;</span> Decrypt &amp; Recover
        </button>

        <div id="progress-bar" class="progress-bar hidden">
          <div class="fill" style="width: 0%"></div>
        </div>

        <p id="status-message" class="status-message"></p>

        <div id="files-list" class="files-list"></div>

        <div id="download-actions" class="download-actions hidden">
          <button id="download-all-btn" class="btn btn-success">
            <span>&#128229;</span> Download Archive (.tar.gz)
          </button>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <p>ReMemory v{{VERSION}} &mdash; Works completely offline</p>
    <p>
      Need help? <a href="{{GITHUB_URL}}" target="_blank">Download CLI tool from GitHub</a>
    </p>
  </footer>

  <!-- Go WASM runtime -->
  <script>{{WASM_EXEC}}</script>

  <!-- Application logic -->
  <script>{{APP_JS}}</script>

  <!-- Embedded WASM binary (base64) -->
  <script>
    const WASM_BINARY = "{{WASM_BASE64}}";
  </script>

  <!-- Load WASM from embedded binary -->
  <script>
    (async function() {
      const go = new Go();
      try {
        // Decode base64 WASM
        const binary = atob(WASM_BINARY);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
          bytes[i] = binary.charCodeAt(i);
        }
        const result = await WebAssembly.instantiate(bytes.buffer, go.importObject);
        go.run(result.instance);
      } catch (err) {
        console.error('Failed to load WASM:', err);
        document.getElementById('loading-overlay').innerHTML =
          '<p style="color: #dc3545;">Failed to load recovery module.<br>Please use the CLI tool instead.</p>';
      }
    })();
  </script>
</body>
</html>
